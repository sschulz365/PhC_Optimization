#Sean Billings, 2015
import random
import numpy
import subprocess
import constraints
from experiment import Experiment
from objectiveFunctions import WeightedSumObjectiveFunction, IdealDifferentialObjectiveFunction
from waveGuideMPBOptimizer import differentialEvolution, createPopulation, gradientDescentAlgorithm
import math
from spea_optimizer import SpeaOptimizer
from photonicCrystalDesign import PhCWDesign
from paretoFunctions import ParetoMaxFunction
from photonicCrystalDesign import PhCWDesign


# absolute path to the mpb executable
mpb = "/Users/sean/documents/mpb-1.5/mpb/mpb"

# absolute path to the input ctl
inputFile = "/Users/sean/UniversityOfOttawa/Photonics/PCWO/W1_2D_v04.ctl.txt"

# absolute path to the output ctl
outputFile = "/Users/sean/UniversityOfOttawa/Photonics/PCWO/optimizerTestFile.txt"


# we define a general experiment object
# that we reuse whenever we need to make a command-line mpb call
# see experiment.py for functionality
experiment = Experiment(mpb, inputFile, outputFile)
# ex.setParams(paramVector)
experiment.setCalculationType('4') # accepts an int from 0 to 5
experiment.setBand(23)


# see constraints.py
constraintFunctions = [constraints.latticeConstraintsLD]
"""
solutions = [{'p2': -0.141097, 'p3':  -0.103654, 'p1':  -0.036361, 'r0':  0.431896, 'r1':  0.297492, 'r2':  0.367362, 'r3':  0.422015, 's3':  -0.112887, 's2':  -0.070057, 's1':  -0.076893  },
  {'p2':  -0.189946, 'p3':  -0.072727, 'p1':  -0.08754, 'r0':  0.326291, 'r1':  0.297492, 'r2':  0.393702, 'r3':  0.422015, 's3':  -0.085505, 's2':  -0.067667, 's1':  -0.076893  },
  {'p2':  -0.129559, 'p3':  -0.072727, 'p1':  -0.042209, 'r0':  0.318333, 'r1': 0.297492, 'r2':  0.41937, 'r3':  0.422015, 's3':  -0.123344, 's2':  -0.052251, 's1':  -0.076893  },
  {'p2':  -0.0, 'p3':  -0.009, 'p1':  -0.0, 'r0':   0.2, 'r1':  0.2, 'r2':  0.2, 'r3':  0.2, 's3':  -0.486988, 's2':  -0.0, 's1':  -0.0  },
  {'p2':  -0.246262, 'p3':  -0.114544, 'p1':  -0.155116, 'r0':  0.279154, 'r1': 0.441711, 'r2':  0.412362, 'r3':  0.412737, 's3':  -0.0, 's2':  -0.13086, 's1':  -0.09272},
  {'p2':  -0.0, 'p3':  -0.0, 'p1':  -0.0, 'r0': 0.2, 'r1':  0.2, 'r2':  0.2, 'r3':  0.2, 's3':  -0.0, 's2':  -0.0, 's1':  -0.0},
  {'p2':  -0.071261, 'p3':  -0.070895, 'p1':  -0.073198, 'r0':  0.325571, 'r1': 0.405279, 'r2':  0.363834, 'r3':  0.351201, 's3':  -0.111738, 's2':  -0.027332, 's1':  -0.037856  },
  {'p2':  -0.282192, 'p3':  -0.082063, 'p1':  -0.0, 'r0':   0.336795, 'r1': 0.35814, 'r2':  0.426718, 'r3':  0.421833, 's3':  -0.176665, 's2':  -0.087948, 's1':  -0.126083  },
  {'p2':  -0.194136, 'p3':  -0.063359, 'p1':  -0.051546, 'r0':  0.328163, 'r1': 0.299364, 'r2':  0.430813, 'r3':  0.411329, 's3':  -0.147385, 's2':  -0.107474, 's1':  -0.075079},
  {'p2':  -0.234404, 'p3':  -0.002472, 'p1':  -0.126254, 'r0':  0.20036, 'r1':  0.204657, 'r2':  0.20072, 'r3':  0.20072, 's3':  -0.027193, 's2':  -0.161745, 's1':  -0.118674  },
  {'p2':  -0.122572, 'p3':  -0.003321, 'p1':  -0.099305, 'r0':  0.20072, 'r1':  0.200144, 'r2':  0.242899, 'r3':  0.231226, 's3':  -0.029056, 's2':  -0.188909, 's1':  -0.116587 },
  {'p2':  -0.184911, 'p3':  -0.000542, 'p1':  -0.151248, 'r0':  0.2, 'r1':   0.2, 'r2':  0.276094, 'r3': 0.2, 's3':  -0.039187, 's2':  -0.187613, 's1':  -0.114715  },
  {'p2':  -0.149739, 'p3':  -0.001584, 'p1':  -0.024683, 'r0':  0.2, 'r1':  0.20083, 'r2':  0.290892, 'r3':  0.204032, 's3':  -0.004072, 's2':  -0.073586, 's1':  -0.198645},
  {'p2':  -0.209395, 'p3':  -0.001102, 'p1':  -0.152738, 'r0':  0.2, 'r1':  0.219201, 'r2':  0.276094, 'r3':  0.213233, 's3':  -0.020127, 's2':  -0.118946, 's1':  -0.153861},
  {'p2':  -0.210475, 'p3':  -0.042662, 'p1':  -0.162253, 'r0':  0.2, 'r1':  0.2, 'r2':  0.269254, 'r3':  0.21332, 's3':  -0.079816, 's2':  -0.16495, 's1':  -0.171813  },
  {'p2':  -0.220463, 'p3':  -0.011404, 'p1':  -0.186009, 'r0':  0.21152, 'r1':  0.21008, 'r2':  0.275734, 'r3':  0.21152, 's3':  -0.041669, 's2':  -0.078052, 's1':  -0.164661},
  {'p2':  -0.184911, 'p3':  -0.000542, 'p1':  -0.151248, 'r0':  0.2, 'r1':  0.2, 'r2': 0.276094, 'r3':  0.2, 's3':  -0.039187, 's2':  -0.187613, 's1':  -0.134893  },
  {'p2':  -0.010476, 'p3':  -0.443457, 'p1':  -0.012286, 'r0':  0.38804, 'r1':  0.40663, 'r2': 0.355022, 'r3': 0.431155, 's3':  -0.031994, 's2':  -0.085246, 's1':  -0.17049  } ]

solutions = [{'p2': -0.184911, 'p3': -0.001792, 'p1': -0.177079, 'r0': 0.2, 'r1': 0.2, 'r2': 0.242899, 'r3': 0.2, 's3': -0.029056, 's2': -0.187613, 's1': -0.116587},
            {'p2': 0.211272, 'p3': -0.042682, 'p1': -0.153843, 'r0': 0.236084, 'r1': 0.2, 'r2': 0.310876, 'r3': 0.2, 's3': -0.078033, 's2': -0.095436, 's1': 0.058},
            {'p2': -0.209712, 'p3': -0.040338, 'p1': 0.172176, 'r0': 0.2, 'r1': 0.2, 'r2': 0.269577, 'r3': 0.245116, 's3': -0.040287, 's2': -0.1803, 's1': -0.136598},
            {'p2': 0.223957, 'p3': -0.042682, 'p1': -0.165299, 'r0': 0.236084, 'r1': 0.208826, 'r2': 0.297488, 'r3': 0.2, 's3': -0.077673, 's2': -0.095436, 's1': 0.0636},
            {'p2': -0.210475, 'p3': -0.042662, 'p1': -0.162253, 'r0': 0.2, 'r1': 0.2, 'r2': 0.264382, 'r3': 0.231593, 's3': -0.070369, 's2': -0.118355, 's1': -0.12171},
            {'p2': -0.210475, 'p3': -0.042662, 'p1': -0.162253, 'r0': 0.2, 'r1': 0.2, 'r2': 0.264382, 'r3': 0.231593, 's3': -0.070369, 's2': -0.153377, 's1': -0.12171},
            {'p2': -0.14409, 'p3': 0.002223, 'p1': -0.162253, 'r0': 0.2, 'r1': 0.204156, 'r2': 0.264382, 'r3': 0.231593, 's3': -0.070369, 's2': -0.153377, 's1': -0.12171},
            {'p2': -0.184911, 'p3': -0.000542, 'p1': -0.151248, 'r0': 0.2, 'r1': 0.214232, 'r2': 0.273873, 'r3': 0.239776, 's3': -0.039187, 's2': 0.185027, 's1': -0.112249},
            {'p2': -0.243149, 'p3': 0.000558, 'p1': 0.172176, 'r0': 0.2, 'r1': 0.250731, 'r2': 0.286036, 'r3': 0.245116, 's3': -0.040287, 's2': -0.1803, 's1': -0.136598},
            {'p2': -0.210475, 'p3': -0.042662, 'p1': 0.124599, 'r0': 0.2, 'r1': 0.2, 'r2': 0.269254, 'r3': 0.229892, 's3': -0.07051, 's2': -0.16495, 's1': -0.171813},
            {'p2': -0.184911, 'p3': -0.003321, 'p1': -0.151248, 'r0': 0.2, 'r1': 0.2, 'r2': 0.242899, 'r3': 0.2, 's3': -0.029056, 's2': -0.187613, 's1': -0.116587},
            {'p2': -0.189946, 'p3': -0.072727, 'p1': -0.08754, 'r0': 0.326291, 'r1': 0.297492, 'r2': 0.393702, 'r3': 0.422015, 's3': -0.085505, 's2': -0.067667, 's1': -0.076893},
            {'p2': -0.010476, 'p3': -0.443457, 'p1': -0.012286, 'r0': 0.38804, 'r1': 0.40663, 'r2': 0.355022, 'r3': 0.431155, 's3': -0.031994, 's2': -0.085246, 's1': -0.17049},{'p2':  -0.184911, 'p3':  -0.000542, 'p1':  -0.151248, 'r0':  0.2, 'r1':   0.2, 'r2':  0.276094, 'r3': 0.2, 's3':  -0.039187, 's2':  -0.187613, 's1':  -0.114715  },
            {'p2':  -0.149739, 'p3':  -0.001584, 'p1':  -0.024683, 'r0':  0.2, 'r1':  0.20083, 'r2':  0.290892, 'r3':  0.204032, 's3':  -0.004072, 's2':  -0.073586, 's1':  -0.198645},
            {'p2':  -0.209395, 'p3':  -0.001102, 'p1':  -0.152738, 'r0':  0.2, 'r1':  0.219201, 'r2':  0.276094, 'r3':  0.213233, 's3':  -0.020127, 's2':  -0.118946, 's1':  -0.153861},
            {'p2':  -0.210475, 'p3':  -0.042662, 'p1':  -0.162253, 'r0':  0.2, 'r1':  0.2, 'r2':  0.269254, 'r3':  0.21332, 's3':  -0.079816, 's2':  -0.16495, 's1':  -0.171813  },
            {'p2':  -0.220463, 'p3':  -0.011404, 'p1':  -0.186009, 'r0':  0.21152, 'r1':  0.21008, 'r2':  0.275734, 'r3':  0.21152, 's3':  -0.041669, 's2':  -0.078052, 's1':  -0.164661},
            {'p2':  -0.184911, 'p3':  -0.000542, 'p1':  -0.151248, 'r0':  0.2, 'r1':  0.2, 'r2': 0.276094, 'r3':  0.2, 's3':  -0.039187, 's2':  -0.187613, 's1':  -0.134893  },
            {'p2':  -0.010476, 'p3':  -0.443457, 'p1':  -0.012286, 'r0':  0.38804, 'r1':  0.40663, 'r2': 0.355022, 'r3': 0.431155, 's3':  -0.031994, 's2':  -0.085246, 's1':  -0.17049  } ]
"""
solutions = [{'p2': 0.005009, 'p3': 0.006596, 'p1': -0.135418, 'r0': 0.237322, 'r1': 0.2, 'r2': 0.383745, 'r3': 0.2, 's3': -0.046694, 's2': -0.094858, 's1': -0.062471},
 {'p2': -0.19244, 'p3': 0.001644, 'p1': -0.152738, 'r0': 0.2, 'r1': 0.266403, 'r2': 0.240238, 'r3': 0.265909, 's3': -0.019961, 's2': -0.09365, 's1': -0.131561},
 {'p2': -0.158791, 'p3': 0.030778, 'p1': -0.141671, 'r0': 0.297091, 'r1': 0.2, 'r2': 0.341488, 'r3': 0.238264, 's3': 0.05995, 's2': -0.149409, 's1': -0.095711},
 {'p2': -0.259401, 'p3': -0.000774, 'p1': 0.124599, 'r0': 0.223115, 'r1': 0.244706, 'r2': 0.292582, 'r3': 0.2, 's3': -0.07421, 's2': -0.092381, 's1': -0.123115},
 {'p2': 0.171362, 'p3': 0.001644, 'p1': 0.124599, 'r0': 0.2, 'r1': 0.2, 'r2': 0.2, 'r3': 0.2, 's3': -0.018858, 's2': -0.204392, 's1': -0.108935},
 {'p2': -0.157476, 'p3': -0.050961, 'p1': -0.145734, 'r0': 0.2, 'r1': 0.227629, 'r2': 0.28966, 'r3': 0.272386, 's3': -0.07051, 's2': -0.116947, 's1': -0.131717},
 {'p2': 0.169217, 'p3': 0.030888, 'p1': 0.124599, 'r0': 0.2279, 'r1': 0.237683, 'r2': 0.4, 'r3': 0.2, 's3': 0.094071, 's2': -0.097843, 's1': 0.063663},
 {'p2': 0.211272, 'p3': -0.042682, 'p1': 0.124599, 'r0': 0.206353, 'r1': 0.2, 'r2': 0.292582, 'r3': 0.2, 's3': -0.07421, 's2': -0.095436, 's1': -0.123115},
 {'p2': 0.126122, 'p3': -0.027806, 'p1': 0.124599, 'r0': 0.235128, 'r1': 0.242938, 'r2': 0.2, 'r3': 0.278004, 's3': 0.084515, 's2': -0.048079, 's1': 0.067113},
 {'p2': 0.200715, 'p3': 0.05068, 'p1': 0.067357, 'r0': 0.2279, 'r1': 0.237683, 'r2': 0.4, 'r3': 0.2, 's3': -0.091657, 's2': -0.077118, 's1': 0.063663},
 {'p2': 0.005009, 'p3': 0.006596, 'p1': -0.115785, 'r0': 0.237322, 'r1': 0.2, 'r2': 0.383745, 'r3': 0.2, 's3': -0.046694, 's2': -0.101481, 's1': -0.062471},
 {'p2': 0.234399, 'p3': -0.001729, 'p1': 0.124599, 'r0': 0.2, 'r1': 0.2, 'r2': 0.310876, 'r3': 0.2, 's3': -0.078033, 's2': -0.095436, 's1': -0.13246},
 {'p2': 0.005009, 'p3': 0.004437, 'p1': -0.141671, 'r0': 0.220114, 'r1': 0.203036, 'r2': 0.383745, 'r3': 0.2, 's3': -0.046694, 's2': -0.101481, 's1': -0.069293},
 {'p2': 0.269865, 'p3': -0.002661, 'p1': -0.141671, 'r0': 0.223115, 'r1': 0.231531, 'r2': 0.383745, 'r3': 0.2, 's3': -0.040287, 's2': -0.101481, 's1': 0.058},
 {'p2': -0.209395, 'p3': 0.001035, 'p1': -0.152738, 'r0': 0.266314, 'r1': 0.2, 'r2': 0.203594, 'r3': 0.213233, 's3': -0.020123, 's2': -0.095436, 's1': 0.063663},
 {'p2': 0.145875, 'p3': -0.052244, 'p1': 0.117367, 'r0': 0.2, 'r1': 0.260604, 'r2': 0.4, 'r3': 0.2, 's3': 0.059225, 's2': -0.085618, 's1': -0.134903},
 {'p2': -0.209395, 'p3': 0.001035, 'p1': -0.152738, 'r0': 0.2, 'r1': 0.2, 'r2': 0.203594, 'r3': 0.213233, 's3': -0.020123, 's2': -0.109988, 's1': -0.108935},
 {'p2': 0.00519, 'p3': 0.004437, 'p1': -0.141671, 'r0': 0.223115, 'r1': 0.231531, 'r2': 0.383745, 'r3': 0.2, 's3': -0.040287, 's2': -0.101481, 's1': -0.07594},
 {'p2': 0.211272, 'p3': -0.042682, 'p1': 0.124599, 'r0': 0.2, 'r1': 0.2, 'r2': 0.310876, 'r3': 0.2, 's3': -0.078033, 's2': -0.095436, 's1': -0.13246},
 {'p2': -0.175329, 'p3': 0.001427, 'p1': 0.172176, 'r0': 0.2, 'r1': 0.250731, 'r2': 0.286036, 'r3': 0.2, 's3': -0.040287, 's2': -0.206823, 's1': -0.136598},
 {'p2': -0.183314, 'p3': -0.050542, 'p1': -0.141671, 'r0': 0.2, 'r1': 0.260604, 'r2': 0.355695, 'r3': 0.2, 's3': 0.080771, 's2': -0.092188, 's1': -0.134903},
 {'p2': 0.305666, 'p3': -0.002079, 'p1': 0.226132, 'r0': 0.2, 'r1': 0.2, 'r2': 0.244564, 'r3': 0.227293, 's3': 0.032375, 's2': 0.161428, 's1': 0.198186},
 {'p2': 0.223957, 'p3': 0.05068, 'p1': 0.124599, 'r0': 0.2279, 'r1': 0.237683, 'r2': 0.4, 'r3': 0.2, 's3': -0.091657, 's2': -0.077118, 's1': 0.063663},
 {'p2': -0.243149, 'p3': 0.000558, 'p1': 0.172176, 'r0': 0.2, 'r1': 0.250731, 'r2': 0.286036, 'r3': 0.245116, 's3': -0.040287, 's2': -0.1803, 's1': -0.136598},
 {'p2': -0.158791, 'p3': -0.050961, 'p1': 0.124599, 'r0': 0.2, 'r1': 0.227629, 'r2': 0.338433, 'r3': 0.272386, 's3': -0.07051, 's2': -0.141022, 's1': -0.131717},
 {'p2': -0.210475, 'p3': -0.050961, 'p1': 0.124599, 'r0': 0.2, 'r1': 0.227629, 'r2': 0.294188, 'r3': 0.272386, 's3': -0.07051, 's2': -0.16495, 's1': -0.13535},
 {'p2': 0.223957, 'p3': -0.042682, 'p1': -0.165299, 'r0': 0.266314, 'r1': 0.208826, 'r2': 0.335955, 'r3': 0.204147, 's3': -0.092404, 's2': -0.095436, 's1': 0.063663},
 {'p2': -0.209395, 'p3': 7.5e-05, 'p1': -0.152738, 'r0': 0.2, 'r1': 0.203047, 'r2': 0.276094, 'r3': 0.213233, 's3': -0.020123, 's2': -0.109988, 's1': -0.108935},
 {'p2': 0.211272, 'p3': -0.042682, 'p1': -0.153843, 'r0': 0.236084, 'r1': 0.2, 'r2': 0.310876, 'r3': 0.2, 's3': -0.078033, 's2': -0.095436, 's1': 0.058},
 {'p2': -0.210475, 'p3': -0.042662, 'p1': -0.162253, 'r0': 0.2, 'r1': 0.2, 'r2': 0.264382, 'r3': 0.231593, 's3': -0.070369, 's2': -0.153377, 's1': -0.12171}]

population = []
for vector in solutions:
    pcw = PhCWDesign(vector, 0, constraintFunctions)
    population.append(pcw.copy_phc())

max_generation = 20 # number of iterations for SPEA
population_size = 30 # number of solutions to consider in SPEA
pareto_archive_size = 40 # number of solutions to store in the SPEA PAS
tournament_selection_rate  = 5 # number of solutions to consider for evolution in SPEA

#Initialize objective function
#objFunc = IdealDifferentialObjectiveFunction(weights, experiment, ideal)
key_map = {}
key_map["ng0"] = "max"
key_map["bandwidth"] = "max"
key_map["GBP"] = "max"

pareto_function = ParetoMaxFunction(experiment, key_map)
"""
population2 = SpeaOptimizer.createPopulation(population_size - len(population),pcw)
for p in population2:
    population.append(p)
"""
# SPEA section

print "Starting SPEA"


optimizer = SpeaOptimizer(pareto_function)

optimizer.optimize(population,max_generation,tournament_selection_rate, pareto_archive_size)

